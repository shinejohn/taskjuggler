# =============================================================================
# NIXPACKS.TOML - Laravel 12 + Vue 3 + Tailwind 4 Build Configuration
# =============================================================================
# This file tells Railway/Nixpacks how to build your application.
# This version is for when Railway root directory is set to taskjuggler-api
# =============================================================================

[phases.setup]
# All PHP extensions your app needs
nixPkgs = [
    # PHP 8.3 core
    "php83",
    
    # Database extensions
    "php83Extensions.pdo",
    "php83Extensions.pdo_pgsql",
    "php83Extensions.pgsql",
    
    # Cache/Queue extensions
    "php83Extensions.redis",
    
    # Process control (required for Horizon)
    "php83Extensions.pcntl",
    
    # Common extensions
    "php83Extensions.bcmath",
    "php83Extensions.gd",
    "php83Extensions.intl",
    "php83Extensions.mbstring",
    "php83Extensions.xml",
    "php83Extensions.dom",
    "php83Extensions.zip",
    "php83Extensions.curl",
    "php83Extensions.fileinfo",
    "php83Extensions.tokenizer",
    "php83Extensions.ctype",
    "php83Extensions.openssl",
    "php83Extensions.sodium",
    
    # Node.js for Laravel Vite asset compilation
    "nodejs_20",
    "npm"
]

[phases.install]
# Install dependencies and build assets
cmds = [
    # PHP dependencies (production only, optimized)
    "composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist --no-progress",
    
    # Node dependencies (clean install, faster and more reliable)
    "npm ci --prefer-offline --no-audit --no-fund",
    
    # Build Laravel assets (CSS/JS via Vite)
    "npm run build",
    
    # Ensure storage directories exist
    "mkdir -p storage/framework/sessions",
    "mkdir -p storage/framework/views",
    "mkdir -p storage/framework/cache/data",
    "mkdir -p storage/logs",
    "mkdir -p bootstrap/cache",
    
    # Set permissions
    "chmod -R 775 storage",
    "chmod -R 775 bootstrap/cache"
]

[phases.build]
# Laravel optimizations - these cache config for faster boot
# The "|| true" ensures build doesn't fail if these commands error
cmds = [
    "php artisan package:discover --ansi || true",
    "php artisan config:cache || true",
    "php artisan route:cache || true",
    "php artisan view:cache || true",
    "php artisan event:cache || true"
]

[start]
# Default start command for web service
# Runs migrations, creates storage link, starts server
cmd = """
php artisan migrate --force --no-interaction && \
php artisan storage:link --force || true && \
php artisan serve --host=0.0.0.0 --port=${PORT:-8080}
"""
