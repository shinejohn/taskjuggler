[phases.setup]
nixPkgs = [
    # PHP 8.3 core
    "php83",
    
    # Database extensions
    "php83Extensions.pdo",
    "php83Extensions.pdo_pgsql",
    "php83Extensions.pgsql",
    
    # Cache/Queue extensions
    "php83Extensions.redis",
    
    # Process control (required for Horizon)
    "php83Extensions.pcntl",
    
    # Common extensions
    "php83Extensions.bcmath",
    "php83Extensions.gd",
    "php83Extensions.intl",
    "php83Extensions.mbstring",
    "php83Extensions.xml",
    "php83Extensions.dom",
    "php83Extensions.zip",
    "php83Extensions.curl",
    "php83Extensions.fileinfo",
    "php83Extensions.tokenizer",
    "php83Extensions.ctype",
    "php83Extensions.openssl",
    "php83Extensions.sodium",
    
    # Node.js 20 (base) - will upgrade to Node.js 24 in install phase for Vite 7
    "nodejs_20",
    
    # Composer for PHP dependency management
    "php83Packages.composer"
]

[phases.install]
cmds = [
    # Install Node.js 24 (required for Vite 7)
    # Download and install latest Node.js 24 to /usr/local
    "curl -fsSL https://nodejs.org/dist/v24.11.1/node-v24.11.1-linux-x64.tar.xz -o /tmp/node.tar.xz && tar -xJf /tmp/node.tar.xz -C /tmp && rm /tmp/node.tar.xz",
    "cp -r /tmp/node-v24.11.1-linux-x64/* /usr/local/ && rm -rf /tmp/node-v24.11.1-linux-x64",
    "export PATH=\"/usr/local/bin:$PATH\" && node --version && npm --version",
    
    # PHP dependencies (production only, optimized)
    "composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist --no-progress",
    
    # Node dependencies for API (Laravel Vite assets)
    "export PATH=\"/usr/local/bin:$PATH\" && npm install --no-audit --no-fund",
    
    # Build Laravel frontend assets
    "export PATH=\"/usr/local/bin:$PATH\" && npm run build",
    
    # Ensure storage directories exist
    "mkdir -p storage/framework/sessions",
    "mkdir -p storage/framework/views",
    "mkdir -p storage/framework/cache/data",
    "mkdir -p storage/logs",
    "mkdir -p bootstrap/cache",
    
    # Set permissions
    "chmod -R 775 storage",
    "chmod -R 775 bootstrap/cache"
]

[phases.build]
# Laravel optimizations - these cache config for faster boot
# The "|| true" ensures build doesn't fail if these commands error
cmds = [
    "php artisan package:discover --ansi || true",
    "php artisan config:cache || true",
    "php artisan route:cache || true",
    "php artisan view:cache || true",
    "php artisan event:cache || true"
]

[start]
# Default start command for web service
# Runs migrations, creates storage link, starts server
cmd = "php artisan migrate --force --no-interaction && php artisan storage:link --force || true && php artisan serve --host=0.0.0.0 --port=${PORT:-8080}"

